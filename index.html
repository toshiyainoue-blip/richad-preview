<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>リッチアド テスト環境</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: #eee;
      font-family: sans-serif;
    }
    #preview {
      width: 375px;
      margin: auto;
      background: #fff;
      border: 1px solid #ccc;
      min-height: 200px;
    }
  </style>
</head>
<body>

<h3>リッチアド プレビュー</h3>
<div id="preview"></div>

<script>
const params = new URLSearchParams(location.search);
const code = params.get("code");

if (code) {
  const html = decodeURIComponent(code);
  const container = document.getElementById("preview");

  // まずそのままHTMLごと流し込む（この時点では <script> は動かない）
  container.innerHTML = html;

  // container 内の <script> を全部取り出して「同じ場所に差し替え」
  const scripts = container.querySelectorAll("script");

  scripts.forEach(oldScript => {
    const newScript = document.createElement("script");
    newScript.async = false; // 可能な限り元の順番で実行させたい

    // 属性をすべてコピー（src含む）
    Array.from(oldScript.attributes).forEach(attr => {
      newScript.setAttribute(attr.name, attr.value);
    });

    // インラインスクリプトなら中身もコピー
    if (!oldScript.src) {
      newScript.textContent = oldScript.textContent;
    }

    // oldScript と置き換え（DOMの場所・順番を維持）
    oldScript.parentNode.replaceChild(newScript, oldScript);
  });
}
</script>

</body>
</html>
